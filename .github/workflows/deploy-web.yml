name: Deploy Web App

on:
  push:
    branches: [master]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, tokenizer
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Run Pint (check only)
        run: vendor/bin/pint --test

      - name: Run Larastan
        run: vendor/bin/phpstan analyse --memory-limit=512M

      - name: Prepare SQLite database
        run: touch database/database.sqlite

      - name: Copy .env
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run Pest tests
        run: vendor/bin/pest --parallel

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy via rsync
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e rsync -avz --delete \
            --exclude='.env' \
            --exclude='storage/app/' \
            --exclude='storage/framework/cache/data/' \
            --exclude='storage/framework/sessions/' \
            --exclude='storage/framework/views/' \
            --exclude='storage/logs/' \
            --exclude='storage/media-library/' \
            --exclude='node_modules/' \
            --exclude='vendor/' \
            --exclude='.git/' \
            --exclude='tests/' \
            --exclude='database/database.sqlite' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/orchestra-mcp/htdocs/orchestra-mcp.dev/

      - name: Run post-deploy commands
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'DEPLOY_SCRIPT'
          cd /home/orchestra-mcp/htdocs/orchestra-mcp.dev

          # Maintenance mode on
          php artisan down --retry=30 || true

          # Install deps and build
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
          npm install
          npm run build

          # Run migrations
          php artisan migrate --force

          # Clear and rebuild caches
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan event:cache

          # Restart queue workers if running
          php artisan queue:restart || true

          # Fix permissions
          chmod -R 775 storage bootstrap/cache
          chown -R orchestra-mcp:orchestra-mcp storage bootstrap/cache

          # Maintenance mode off
          php artisan up
          DEPLOY_SCRIPT
